#!/usr/bin/env python

################################################################
# This is a simple wrapper script around the real filter script.
#
# It catches all possible exceptions and returns EX_TEMPFAIL to
# defer the delivery if anything but SystemExit is thrown.
#
# The traceback is also written to ~/TMDA_DELIVERY_FAILURE if
# possible, and if not, to stdout.
################################################################


import os
import sys
import time
import traceback


program = sys.argv[0]
execdir = os.path.dirname(os.path.abspath(program))

try:
    execfile(os.path.join(execdir, 'tmda-rfilter'))
except KeyboardInterrupt:
    pass
except StandardError:
    try:
        print 'TMDA_DELIVERY_FAILURE'
        fp = open(os.path.expanduser('~/TMDA_DELIVERY_FAILURE'), 'a')
        fp.write('%s (%s):%s' % ('\n' + 'uncaught exception',
                                 time.asctime(time.localtime(time.time())),
                                 '\n' + '-' * 60 + '\n'))
        traceback.print_exc(file=fp)
        fp.close()
        sys.exit(75)
    except StandardError:
        print 'Could not write to ~/TMDA_DELIVERY_FAILURE\n'
        traceback.print_exc(file=sys.stdout)
        sys.exit(75)
