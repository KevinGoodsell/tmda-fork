#!/usr/bin/env python

import commands
import os
import sys


try:
    import paths
except ImportError:
    pass

from TMDA import Util


def keygen():
    """Create and return a unique 160-bit key in hex."""
    # Use the kernel's random number generator if available.
    if os.path.exists("/dev/urandom"):
        key = open("/dev/urandom","rb").read(20)
    # Otherwise generate some pseudo-random data from the command-line
    # and use the SHA of resulting key as the key.
    else:
        import sha
        print "Collecting pseudo-random data from the system..\n"
        unpredictable = ( "date",
                          "fstat",
                          "iostat",
                          "vmstat",
                          "finger",
                          "ps -la",
                          "netstat",
                          "uname -a",
                          "cat /etc/passwd",
                          "cat /etc/aliases",
                          "cat /proc/interrupts" )
        key_data = ''
        for i in unpredictable:
            if commands.getstatusoutput(i)[0] == 0:
                key_data = key_data + os.popen(i).read()
        key = sha.new(key_data + "key").digest()

    return Util.hexlify(key)
        
print "Generating a unique, 160-bit private key, please wait a moment.."
print

key = keygen()

if len(key) != 40:
    print "Oops, generated key is not 40-characters in length, exiting!"
    sys.exit()
    
print "CRYPT_KEY =", '"' + key + '"'
print
print "Now paste this line into your ~/.tmdarc file,"
print "and make sure to keep your key secret!"

